@page "/chat"
@using Microsoft.AspNetCore.SignalR.Client
@inject NavigationManager Navigation
@implements IAsyncDisposable

<PageTitle>Chat - Guía Gastronómica</PageTitle>

<MudContainer MaxWidth="MaxWidth.Large" Class="mt-4">
    <MudPaper Elevation="3" Class="pa-4" Style="height: 70vh; display: flex; flex-direction: column;">
        <MudText Typo="Typo.h4" GutterBottom="true">
            <MudIcon Icon="@Icons.Material.Filled.Chat" /> Asistente Gastronómico
        </MudText>
        <MudText Typo="Typo.body2" Color="Color.Secondary" Class="mb-4">
            Pregúntame sobre restaurantes, bares y lugares para comer en Huelva
        </MudText>

        <!-- Área de mensajes -->
        <MudPaper Elevation="0" Class="flex-grow-1 overflow-auto mb-4 pa-3" Style="background-color: #f5f5f5;">
            @foreach (var message in messages)
            {
                <MudPaper Elevation="1" Class="mb-2 pa-3" Style="@GetMessageStyle(message.IsUser)">
                    <MudText Typo="Typo.body2" Style="@GetMessageTextStyle(message.IsUser)">
                        @if (!message.IsUser)
                        {
                            <MudIcon Icon="@Icons.Material.Filled.SmartToy" Size="Size.Small" Class="mr-2" />
                        }
                        @message.Text
                    </MudText>
                    <MudText Typo="Typo.caption" Color="Color.Secondary" Class="mt-1">
                        @message.Timestamp.ToString("HH:mm")
                    </MudText>
                </MudPaper>
            }
            @if (isThinking)
            {
                <MudPaper Elevation="1" Class="mb-2 pa-3" Style="background-color: white; border-left: 4px solid #594ae2;">
                    <MudProgressCircular Color="Color.Primary" Size="Size.Small" Indeterminate="true" />
                    <MudText Typo="Typo.body2" Class="ml-2" Style="display: inline;">Pensando...</MudText>
                </MudPaper>
            }
            <div @ref="messagesEnd"></div>
        </MudPaper>

        <!-- Área de input -->
        <MudGrid Spacing="2">
            <MudItem xs="10">
                <MudTextField @bind-Value="userMessage" 
                             Label="Escribe tu pregunta..." 
                             Variant="Variant.Outlined"
                             OnKeyDown="HandleKeyDown"
                             Disabled="@(!IsConnected || isThinking)"
                             FullWidth="true" />
            </MudItem>
            <MudItem xs="2">
                <MudButton Variant="Variant.Filled" 
                          Color="Color.Primary" 
                          OnClick="Send" 
                          Disabled="@(!IsConnected || string.IsNullOrWhiteSpace(userMessage) || isThinking)"
                          FullWidth="true"
                          Style="height: 56px;">
                    <MudIcon Icon="@Icons.Material.Filled.Send" />
                </MudButton>
            </MudItem>
        </MudGrid>

        @if (!IsConnected)
        {
            <MudAlert Severity="Severity.Warning" Class="mt-2">
                Conectando al servidor... Por favor espera.
            </MudAlert>
        }
    </MudPaper>
</MudContainer>

@code {
    private HubConnection? hubConnection;
    private List<ChatMessage> messages = new();
    private string userMessage = "";
    private bool isThinking = false;
    private ElementReference messagesEnd;

    private bool IsConnected => hubConnection?.State == HubConnectionState.Connected;

    protected override async Task OnInitializedAsync()
    {
        hubConnection = new HubConnectionBuilder()
            .WithUrl("http://localhost:5001/chathub")
            .WithAutomaticReconnect()
            .Build();

        hubConnection.On<string>("ReceiveMessage", (message) =>
        {
            messages.Add(new ChatMessage
            {
                Text = message,
                IsUser = false,
                Timestamp = DateTime.Now
            });
            isThinking = false;
            InvokeAsync(StateHasChanged);
        });

        try
        {
            await hubConnection.StartAsync();
        }
        catch (Exception ex)
        {
            messages.Add(new ChatMessage
            {
                Text = $"Error al conectar: {ex.Message}",
                IsUser = false,
                Timestamp = DateTime.Now
            });
        }
    }

    private async Task Send()
    {
        if (string.IsNullOrWhiteSpace(userMessage) || !IsConnected)
            return;

        var message = userMessage.Trim();
        messages.Add(new ChatMessage
        {
            Text = message,
            IsUser = true,
            Timestamp = DateTime.Now
        });

        userMessage = "";
        isThinking = true;

        try
        {
            await hubConnection!.SendAsync("SendMessage", message);
        }
        catch (Exception ex)
        {
            messages.Add(new ChatMessage
            {
                Text = $"Error al enviar mensaje: {ex.Message}",
                IsUser = false,
                Timestamp = DateTime.Now
            });
            isThinking = false;
        }
    }

    private async Task HandleKeyDown(KeyboardEventArgs e)
    {
        if (e.Key == "Enter" && !e.ShiftKey)
        {
            await Send();
        }
    }

    private string GetMessageStyle(bool isUser)
    {
        return isUser
            ? "background-color: #594ae2; color: white; margin-left: auto; max-width: 70%;"
            : "background-color: white; border-left: 4px solid #594ae2; max-width: 70%;";
    }

    private string GetMessageTextStyle(bool isUser)
    {
        return isUser ? "color: white;" : "color: inherit;";
    }

    public async ValueTask DisposeAsync()
    {
        if (hubConnection is not null)
        {
            await hubConnection.DisposeAsync();
        }
    }

    private class ChatMessage
    {
        public string Text { get; set; } = "";
        public bool IsUser { get; set; }
        public DateTime Timestamp { get; set; }
    }
}
